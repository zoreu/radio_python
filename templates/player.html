<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ radio_name }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --brand-color: #1DB954; --dark-bg: #121212; --card-bg: #1e1e1e; --text-color: #fff; --text-muted: #888; }
        body { font-family: 'Inter', sans-serif; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background: var(--dark-bg); color: var(--text-color); padding: 20px; box-sizing: border-box; }
        .player-container { text-align: center; background: var(--card-bg); padding: 30px 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.7); width: 100%; max-width: 400px; backdrop-filter: blur(10px); }
        .album-art { width: 150px; height: 150px; background: #333; border-radius: 15px; margin: 0 auto 20px auto; display: flex; align-items: center; justify-content: center; font-size: 50px; }
        h1 { margin: 0 0 10px 0; font-size: 2em; }
        #now-playing { font-size: 1.1em; min-height: 1.5em; margin: 10px 0 25px 0; font-weight: bold; color: var(--brand-color); transition: color 0.3s; }
        #status { font-size: 0.9em; color: var(--text-muted); }
        audio { margin-top: 20px; width: 100%; }
        .embed-section { margin-top: 40px; width: 100%; max-width: 400px; }
        textarea { width: 100%; background: #333; color: #ccc; border: 1px solid #444; border-radius: 8px; padding: 10px; font-family: monospace; resize: none; margin-bottom: 10px; }
        .copy-btn { background: var(--brand-color); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        .copy-btn:hover { background: #17a048; }
    </style>
</head>
<body>
    <div class="player-container">
        <div class="album-art">🎵</div>
        <h1>{{ radio_name }}</h1>
        <div id="now-playing">Conectando...</div>
        <audio id="player" controls autoplay></audio>
        <div id="status">Iniciando conexão...</div>
    </div>

    <div class="embed-section">
        <h3 style="text-align: center;">Incorpore este Player</h3>
        <textarea id="embed-code" rows="4" readonly></textarea>
        <button id="copy-button" class="copy-btn">Copiar Código</button>
    </div>

    <script>
        const player = document.getElementById('player');
        const nowPlayingElem = document.getElementById('now-playing');
        const statusElem = document.getElementById('status');
        const embedCodeElem = document.getElementById('embed-code');
        const copyButton = document.getElementById('copy-button');

        // Gera o código do iframe com a URL completa
        const iframeSrc = window.location.origin + '/player_embed';
        embedCodeElem.value = `<iframe src="${iframeSrc}" frameborder="0" allowtransparency="true" style="width:100%; min-height:150px; border:0;"></iframe>`;
        
        copyButton.addEventListener('click', () => {
            embedCodeElem.select();
            document.execCommand('copy');
            copyButton.textContent = 'Copiado!';
            setTimeout(() => { copyButton.textContent = 'Copiar Código'; }, 2000);
        });

        // Lógica do Player (MSE)
        if ('MediaSource' in window) {
            const mediaSource = new MediaSource(); player.src = URL.createObjectURL(mediaSource);
            mediaSource.addEventListener('sourceopen', () => {
                statusElem.textContent = 'Conectado. Iniciando stream...';
                const sourceBuffer = mediaSource.addSourceBuffer('audio/mpeg');
                fetch('/stream').then(response => {
                    const reader = response.body.getReader();
                    function push() {
                        reader.read().then(({ done, value }) => {
                            if (done) return;
                            const append = () => { if (value) try { sourceBuffer.appendBuffer(value); } catch(e) { console.error(e); } };
                            if (sourceBuffer.updating) { sourceBuffer.addEventListener('updateend', append, { once: true }); } else { append(); }
                            push();
                        }).catch(err => console.error(err));
                    }
                    push();
                });
            });
        } else { statusElem.textContent = "Seu navegador não suporta streaming contínuo."; player.src = '/stream'; }
        
        function updateNowPlaying() {
            fetch('/now_playing').then(r => r.text()).then(name => {
                let prettyName = name.replace(/\.mp3$/i, '').replace(/_/g, ' ');
                nowPlayingElem.textContent = prettyName;
                document.title = `${prettyName} - {{ radio_name }}`;
            });
        }
        setInterval(updateNowPlaying, 5000); updateNowPlaying();
    </script>
</body>
</html>